From c75f81817dbb72995e75e4681d865f88c0b2d081 Mon Sep 17 00:00:00 2001
From: "muhammed.asif" <muhammed.asif@dicortech.com>
Date: Wed, 31 Jan 2024 15:53:20 +0530
Subject: [PATCH] Imporve setup time of spi data line for working at 50mhz

---
 arch/arm64/boot/dts/freescale/imx8qxp-agility.dtsi | 2 +-
 drivers/spi/spi-fsl-lpspi.c                        | 3 +++
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/arch/arm64/boot/dts/freescale/imx8qxp-agility.dtsi b/arch/arm64/boot/dts/freescale/imx8qxp-agility.dtsi
index 2b96d5335..5b7c73d72 100644
--- a/arch/arm64/boot/dts/freescale/imx8qxp-agility.dtsi
+++ b/arch/arm64/boot/dts/freescale/imx8qxp-agility.dtsi
@@ -444,7 +444,7 @@ flash0: SST25VF016B@0 {
 		compatible = "sst,sst25vf016b","jedec,spi-nor";
 		reg = <0>;
 		m25p,fast-read;
-		spi-max-frequency = <25000000>;
+		spi-max-frequency = <50000000>;
 	};
 };
 
diff --git a/drivers/spi/spi-fsl-lpspi.c b/drivers/spi/spi-fsl-lpspi.c
index 4ebfd4433..32de60759 100644
--- a/drivers/spi/spi-fsl-lpspi.c
+++ b/drivers/spi/spi-fsl-lpspi.c
@@ -73,6 +73,7 @@
 #define CFGR1_PINCFG	(BIT(24)|BIT(25))
 #define CFGR1_PCSPOL	BIT(8)
 #define CFGR1_NOSTALL	BIT(3)
+#define CFGR1_SAMPLE	BIT(1)
 #define CFGR1_MASTER	BIT(0)
 #define FSR_TXCOUNT	(0xFF)
 #define RSR_RXEMPTY	BIT(1)
@@ -404,6 +405,8 @@ static int fsl_lpspi_config(struct fsl_lpspi_data *fsl_lpspi)
 		temp = CFGR1_PINCFG;
 	if (fsl_lpspi->config.mode & SPI_CS_HIGH)
 		temp |= CFGR1_PCSPOL;
+	
+	temp |= CFGR1_SAMPLE ;//this will enable the delayed clock to fetch data. this will improve the data setup time
 	writel(temp, fsl_lpspi->base + IMX7ULP_CFGR1);
 
 	temp = readl(fsl_lpspi->base + IMX7ULP_CR);
-- 
2.25.1

